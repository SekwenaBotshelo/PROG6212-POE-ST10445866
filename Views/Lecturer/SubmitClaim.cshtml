@model PROG6212_POE.Models.Claim
@{
    ViewData["Title"] = "Submit Claim";
}

<div class="container mt-5">
    <h2 class="mb-4 text-center">Submit Monthly Claim</h2>

    <!-- Lecturer Info -->
    @if (ViewBag.CurrentUser != null)
    {
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Lecturer Information</h5>
                <p class="mb-1"><strong>Name:</strong> @ViewBag.CurrentUser.FullName</p>
                <p class="mb-0"><strong>Hourly Rate:</strong> R @ViewBag.CurrentUser.HourlyRate</p>
            </div>
        </div>
    }

    <form asp-action="SubmitClaim" method="post" enctype="multipart/form-data" class="shadow p-4 rounded bg-light" id="claimForm">
        @Html.AntiForgeryToken()

        <!-- Auto-populated fields (hidden) -->
        <input type="hidden" asp-for="LecturerId" />

        <div class="form-group mb-3">
            <label asp-for="Month" class="form-label">Claim Month *</label>
            <input asp-for="Month" type="month" class="form-control" required
                   min="2024-01" max="2026-12" />
            <span asp-validation-for="Month" class="text-danger"></span>
            <small class="form-text text-muted">Select the month you're claiming for</small>
        </div>

        <div class="form-group mb-3">
            <label asp-for="TotalHours" class="form-label">Hours Worked *</label>
            <input asp-for="TotalHours" class="form-control" id="hoursWorked"
                   min="1" max="180" step="0.5" required
                   placeholder="Enter hours between 1 and 180" />
            <span asp-validation-for="TotalHours" class="text-danger"></span>
            <small class="form-text text-muted">Maximum 180 hours per month allowed</small>
        </div>

        <!-- Auto-calculation display -->
        <div class="form-group mb-3">
            <label class="form-label">Calculated Amount</label>
            <div class="input-group">
                <span class="input-group-text">R</span>
                <input type="text" class="form-control" id="totalAmount" readonly
                       placeholder="Amount will be calculated automatically" />
            </div>
        </div>

        <div class="form-group mb-3">
            <label asp-for="Notes" class="form-label">Additional Notes <small class="text-muted">(Optional)</small></label>
            <textarea asp-for="Notes" class="form-control" rows="3"
                      placeholder="Optional: Add any additional information about this claim"></textarea>
        </div>

        <!-- SUPPORTING DOCUMENT SECTION (OPTIONAL) -->
        <div class="form-group mb-3">
            <label for="supportingDocument" class="form-label">Supporting Document <small class="text-muted">(Optional)</small></label>
            <input type="file" class="form-control" id="supportingDocument"
                   name="supportingDocument" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
            <small class="form-text text-muted">
                Optional: Upload PDF, Word documents, or images (JPG, PNG) to support your claim
            </small>
        </div>

        <button type="button" onclick="validateAndSubmit()" class="btn btn-success w-100 mt-3">
            <i class="bi bi-check-lg"></i> Submit Claim
        </button>

        <div class="text-center mt-2">
            <a asp-action="Dashboard" class="btn btn-secondary">Cancel and Return to Dashboard</a>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function() {
            var hourlyRate = @(ViewBag.CurrentUser?.HourlyRate ?? 0);

            $('#hoursWorked').on('input', function() {
                var hours = parseFloat($(this).val()) || 0;
                var total = hours * hourlyRate;
                $('#totalAmount').val('R ' + total.toFixed(2));

                // Validation feedback
                if (hours > 180) {
                    $(this).addClass('is-invalid');
                    $(this).removeClass('is-valid');
                } else if (hours > 0) {
                    $(this).removeClass('is-invalid');
                    $(this).addClass('is-valid');
                } else {
                    $(this).removeClass('is-invalid is-valid');
                }
            });

            // Trigger calculation on page load if there's a value
            if ($('#hoursWorked').val()) {
                $('#hoursWorked').trigger('input');
            }
        });

        function validateAndSubmit() {
            const hours = document.querySelector('[name="TotalHours"]').value;
            const month = document.querySelector('[name="Month"]').value;

            if (!hours || hours <= 0 || hours > 180) {
                Swal.fire('Error', 'Please enter valid hours (1-180).', 'error');
                return;
            }

            if (!month) {
                Swal.fire('Error', 'Please select a month.', 'error');
                return;
            }

            Swal.fire({
                title: 'Ready to Submit?',
                html: `
                    <div class="text-left">
                        <p><strong>Month:</strong> ${month}</p>
                        <p><strong>Hours:</strong> ${hours}</p>
                        <p><strong>Estimated Amount:</strong> R ${(hours * @(ViewBag.CurrentUser?.HourlyRate ?? 0)).toFixed(2)}</p>
                        <p class="text-muted">Please confirm your claim details before submission.</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Submit Claim!',
                cancelButtonText: 'Review Details'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('claimForm').submit();
                }
            });
        }
    </script>
}